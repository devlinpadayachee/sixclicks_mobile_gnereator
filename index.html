<!DOCTYPE html>
<html ng-app="myApp">
<head>
	<title>SC Site Creator</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="style.css" />
	<link rel="stylesheet" href="bower_components/angular-color-picker/angularjs-color-picker.min.css" />
	<!-- <link rel="stylesheet" href="css/creative.css" type="text/css"> -->

  <link rel="stylesheet" href="../../css/bundle.css">
  <link rel="stylesheet" href="../../css/style.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Halant:300,400" rel="stylesheet" type="text/css">

	<script src="js/jquery.js"></script>
	<script src="js/FileSaver.js"></script>
	<script src="bower_components/angular/angular.min.js"></script>
	<script src="bower_components/tinycolor/dist/tinycolor-min.js"></script>
	<script src="bower_components/angular-color-picker/angularjs-color-picker.min.js"></script>
	<script src="bower_components/jszip/dist/jszip.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
  <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
  <script src="https://cdn.firebase.com/libs/angularfire/1.1.4/angularfire.min.js"></script>

  <script>
    angular.module('myApp', ['color.picker','ngAutocomplete', 'firebase'], function($compileProvider) {
      $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|geo|tel):/);
    });

    angular.module('myApp').constant('FIREBASE_URL', 'https://scdev.firebaseio.com/');

    angular.module('myApp').factory('AuthenticationFactory', ['FIREBASE_URL', '$firebaseAuth', '$firebaseObject', function(FIREBASE_URL, $firebaseAuth, $firebaseObject){
      var ref = new Firebase(FIREBASE_URL);
      var auth = $firebaseAuth(ref);

      var myObject = {
        getAuth: function() {
          return auth.$getAuth();
        }, //getAuth
        getUserData: function(uid) {
          var userRef = new Firebase(FIREBASE_URL+'users/'+uid);
          var userObj = $firebaseObject(userRef);
          return userObj.$loaded();
        }
      }; //myObject

      return myObject;
    }]);

    angular.module('myApp').factory('ProjectFactory', ['AuthenticationFactory', 'FIREBASE_URL', '$firebaseObject', function(AuthenticationFactory, FIREBASE_URL, $firebaseObject){
      var myObject = {
        getProject: function(projectId) {
          var projectRef = new Firebase(FIREBASE_URL+'/projects/'+AuthenticationFactory.getAuth().uid+'/'+projectId);
          var projectObj = $firebaseObject(projectRef);
          return projectObj.$loaded();
        }, //getProject
        saveProject: function(projectId, project) {
          var projectRef = new Firebase(FIREBASE_URL+'projects/'+AuthenticationFactory.getAuth().uid+'/'+projectId);
          var projectObj = $firebaseObject(projectRef);

          // define all the project attributes we want to save to the database
          projectObj.address = project.address;
          projectObj.address_url = project.address_url;
          projectObj.title = project.title;
          projectObj.email = project.email;
          projectObj.number = project.number;
          projectObj.primary_colour = project.primary_colour;
          projectObj.secondary_colour = project.secondary_colour;
          projectObj.typography_colour = project.typography_colour;
          projectObj.website = project.website;
          projectObj.date_created = project.date_created;
          projectObj.logo = project.logo;
          projectObj.background = project.background;
          projectObj.name = project.name;
          projectObj.date_updated = Firebase.ServerValue.TIMESTAMP;

          // save the project object to the db
          return projectObj.$save();
        }, //saveProject
        subtractCredit: function() {
          var userRef = new Firebase(FIREBASE_URL+'users/'+AuthenticationFactory.getAuth().uid);
          var userObj = $firebaseObject(userRef);
          return userObj.$loaded()
          .then(function(response) {
            userObj.date = response.date;
            userObj.email = response.email;
            userObj.name = response.name;
            userObj.newsletter = response.newsletter;
            userObj.terms = response.terms;
            userObj.uid = response.uid;
            userObj.credits = response.credits-1;
            return userObj.$save();
          });
        }
      }; //myObject

      return myObject;
    }]);

    angular.module('myApp').directive("ngFileSelect",function(){
      return {
        link: function($scope,el){          
          el.bind("change", function(e){          
            $scope.file = (e.srcElement || e.target).files[0];
            $scope.getFile();
          })
        }
      };
    });

    angular.module('myApp').directive("ngFileSelect2",function(){
      return {
        link: function($scope,el){          
          el.bind("change", function(e){          
            $scope.fileBg = (e.srcElement || e.target).files[0];
            $scope.getFileBg();
          })
        }
      };
    });

    angular.module('myApp').controller('myCtrl', ['$rootScope', '$scope', 'fileReader', '$window', 'AuthenticationFactory', 'ProjectFactory', '$location', function($rootScope, $scope, fileReader, $window, AuthenticationFactory, ProjectFactory, $location){
      var authData = AuthenticationFactory.getAuth();

      if (authData == null) {
        $window.location.href = '/myaccount/#/login';
      }

      AuthenticationFactory.getUserData(authData.uid)
      .then(function(response) {
        $scope.userData = response;
      })
      .catch(function(error) {
        console.log(error.message);
        $scope.error = "An error has occured when obtaining user data.";
      });

      // console.log($location.search().id);
      ProjectFactory.getProject($location.search().id)
      .then(function(response) {
        $scope.project = response;
        if ($scope.project.date_updated) {
          $scope.updateCompanyName();
          $scope.updateEmail();
          $scope.updateNumber();
          $scope.updateWebsite();
          document.getElementById('iframe').contentWindow.updatePrimaryColour($scope.project.primary_colour);
          document.getElementById('iframe').contentWindow.updateSecondaryColour($scope.project.secondary_colour);
          document.getElementById('iframe').contentWindow.updateTypographyColour($scope.project.typography_colour);
          document.getElementById('iframe').contentWindow.updateMapsLocation($scope.project.address_url);
          document.getElementById('iframe').contentWindow.updateLogo($scope.project.logo);
          document.getElementById('iframe').contentWindow.updateBackground($scope.project.background);
        }
      })
      .catch(function(error) {
        console.log("An error has occured when obtaining the users' project.");
        $scope.error = error.message;
      });

      $scope.Address = '';
      $scope.Addressoptions = null;
      $scope.Addressdetails = '';
      $scope.DownloadIframeTemplate = function(){
        //Need a way to deduct credits for downloadable files 
        ProjectFactory.subtractCredit()
        .then(function() {
          var iframehtml = $('#iframe').contents().find("html").html();
          // console.log(iframehtml)
          var zip = new JSZip();
          zip.file("index.html", iframehtml);
          var content = zip.generate({type:"blob"});
          // see FileSaver.js
          saveAs(content, "example.zip");
        })
        .catch(function(error) {
          console.log("error occured: "+error);
        }) //a way to deduct credits for downloadable files
        
      };

      $scope.getSaveDetails = function (project) {
        ProjectFactory.saveProject($location.search().id, project)
        .then(function(response) {
          $scope.success = "Project saved successfully";
        })
        .catch(function(error) {
          console.log("An error has occured when attempting to save your project.");
          $scope.error = error.message;
        });
      };

      $scope.getFile = function () {
        $scope.progress = 0;
        $scope.progresswidth = 0;
        fileReader.readAsDataUrl($scope.file, $scope).then(function(result) {
          $scope.project.logo = result;
          // console.log(result)
          document.getElementById('iframe').contentWindow.updateLogo($scope.project.logo);
        });
      };

      $scope.getFileBg = function () {
        $scope.progressBg = 0;
        $scope.progresswidthBg = 0;
        fileReader.readAsDataUrl($scope.fileBg, $scope).then(function(result) {
          $scope.project.background = result;
          // console.log(result)
          document.getElementById('iframe').contentWindow.updateBackground($scope.project.background);
        });
      };

      $scope.$on("fileProgress", function(e, progress) {
        $scope.progress = progress.loaded / progress.total;
        $scope.progresswidth =   "width:" + $scope.progress*100 + "%";
      });

      $scope.updateCompanyName = function() {
        document.getElementById('iframe').contentWindow.updateCompanyName($scope.project.title);
      };

      $scope.updateEmail = function() {
        document.getElementById('iframe').contentWindow.updateEmail($scope.project.email);
      };

      $scope.updateNumber = function() {
        document.getElementById('iframe').contentWindow.updateNumber($scope.project.number);
      };

      $scope.updateWebsite = function() {
        document.getElementById('iframe').contentWindow.updateWwwAddress($scope.project.website);
      };

      $(document).ready(function() {
        $scope.$watch('project.primary_colour', function(newValue, oldValue) {
          if(newValue != oldValue){
            document.getElementById('iframe').contentWindow.updatePrimaryColour($scope.project.primary_colour);
          }
        });

        $scope.$watch('project.secondary_colour', function(newValue, oldValue) {
          if(newValue != oldValue){
            document.getElementById('iframe').contentWindow.updateSecondaryColour($scope.project.secondary_colour);
          }
        });

        $scope.$watch('project.typography_colour', function(newValue, oldValue) {
          if(newValue != oldValue){
            document.getElementById('iframe').contentWindow.updateTypographyColour($scope.project.typography_colour);
          }
        });

        $scope.$watch('project.address', function(newValue, oldValue) {
          if(newValue != oldValue){
            document.getElementById('iframe').contentWindow.updateAddress($scope.project.address);
          }
        });

        $scope.$watch('project.address_details', function(newValue, oldValue) {
          if(newValue !== oldValue){
            // http://maps.google.com/maps?q=24.197611,120.780512
            // console.log(newValue.geometry.location.lat())
            var locationuri = "http://maps.google.com/maps?q="+newValue.geometry.location.lat()+","+newValue.geometry.location.lng()
            // console.log(locationuri)
            $scope.project.address_url = locationuri;
            document.getElementById('iframe').contentWindow.updateMapsLocation(locationuri);
          }
        });
      }); //(document).ready(function()
    }]); //controller('myCtrl')
    </script>

    <script src="js/upload.js"></script>
    <script src="js/ngAutocomplete.js"></script>
</head>
<body ng-controller="myCtrl">
  <!-- Navigation Bar-->
  <header id="topnav">
    <div class="container">
      <!-- Logo container-->
      <div class="logo">
        <a href="/index.html">
          <img src="../../img/logo-light.png" alt="" class="logo-light">
          <img src="../../img/logo-dark.png" alt="" class="logo-dark">
        </a>
      </div>
    </div>
  </header>
  <!-- End Navigation Bar-->
  <div class="container-fluid" ng-show="project.name">
    <div class="row">
      <div class="col-md-12">
        <h1>Now editing project "{{project.name}}."</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h4 ng-hide="project.date_updated">Let's build!</h4>
        <h6 ng-hide="project.date_updated">Simply choose a template, customise it with your company logo, creative colours and images.<br>Then fill in your business's details. When you're ready, click save to save your project.</h6>
        <hr>
        <div class="row">
          <div class="col-md-6">
            <form name="projectForm" role="form">
              <div class="col-md-12">
                <div class="form-group col-md-4">
                  <label>Colours</label>
                </div>
              </div>
              <div class="col-md-12">
                <div class="form-group col-md-4">
                  <color-picker ng-model="project.primary_colour" color-picker-format="'hex'" ></color-picker>
                  <label for="PrimaryColour">
                    Primary
                  </label>
                </div>
                <div class="form-group col-md-4">
                  <color-picker ng-model="project.secondary_colour" color-picker-format="'hex'" ></color-picker>
                  <label for="SecondaryColour">
                    Secondary
                  </label>
                </div>
                <div class="form-group col-md-4">
                  <color-picker ng-model="project.typography_colour" color-picker-format="'hex'" ></color-picker>
                  <label for="TypographyColour">
                    Typography
                  </label>
                </div>
              </div>
              <div class="form-group">
                <label for="ImageLogo">
                  Company Logo
                </label>
                <input type="file" id="ImageLogo" ng-file-select="onFileSelect($files)" >
                <!--  <input type="file" id="ImageLogo" ng-change="updateCompanyLogo()" ng-model="ImageLogo"/> -->
                <p class="help-block">
                  Upload your companies logo
                </p>
              </div>
              <div class="form-group">
                <label for="ImageLogo">
                  Background Image
                </label>
                <input type="file" id="ImageBackground" ng-file-select-2="onFileSelect($files)" >
                <!--  <input type="file" id="ImageLogo" ng-change="updateCompanyLogo()" ng-model="ImageLogo"/> -->
                <p class="help-block">
                  Upload a background image
                </p>
              </div>
              <div class="form-group">
                <label for="CompanyName">
                  Company Name
                </label>
                <input type="text" placeholder = "Your company name" ng-change="updateCompanyName()"  class="form-control" id="CompanyName" ng-model="project.title" required/>
              </div>
              <div class="form-group">
                <label for="Email">
                  Email address
                </label>
                <input type="email" placeholder = "mycompany@example.com" ng-change="updateEmail()" class="form-control" id="Email" ng-model="project.email" required/>
              </div>
              <div class="form-group">
                <label for="Number">
                  Phone Number
                </label>
                <input type="tel" placeholder = "+27118885555" ng-change="updateNumber()" class="form-control" id="Number" ng-model="project.number" required/>
              </div>
              <div class="form-group">
                <label for="address">
                  Address
                </label>
                <input type="text" class="form-control" id="Address" ng-autocomplete="project.address" details="project.address_details" options="Addressoptions" ng-model="project.address" required/>
              </div>
              <div class="form-group">
                <label for="WwwAddress">
                  Website Address (with HTTP/HTTPS)
                </label>
                <input type="url" placeholder = "http://www.example.com" ng-change="updateWebsite()" class="form-control" id="WwwAddress" ng-model="project.website" required/>
              </div>
              <button type="button" class="btn btn-block btn-color m-0 mb-15" ng-click="getSaveDetails(project)" ng-disabled="projectForm.$invalid">
                Save
              </button> 
              <button type="button" ng-click="DownloadIframeTemplate()"  class="btn btn-block btn-color m-0 mb-15" ng-disabled="(userData.credits < 1) || projectForm.$invalid">
                Download HTML files (costs 1 credit, {{userData.credits}} available)
              </button>
              <button type="button" class="btn btn-block btn-color m-0 mb-15" ng-disabled="projectForm.$invalid">
                Email HTML files 
              </button>
              <a href="/myaccount/#/home" class="btn btn-block btn-color m-0 mb-15">Back To My Account</a>
            </form>
          </div>
          <div class="col-md-6">
            <div class="row">
              <div id="phone" class="portrait col-md-12" style="margin-top: 80px;">
                <div id="frame">
                   <iframe width="100%" height="100%" frameborder="0" id="iframe" src="template.html"></iframe>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="../../js/main.js"></script>
  <!-- Footer-->
  <footer id="footer-widgets" class="footer dark">
    <div class="container">
      <div class="row">
        <div class="col-md-3">
          <img src="../../img/logo-light.png">
        </div>
        <div class="col-md-5 ov-h">
          <div class="row">
            <div class="col-sm-4">
              <div class="widget">
                <h6 class="upper">LEARN MORE</h6>
                <ul class="list-unstyled">
                  <li><a href="/about.html">About</a></li>
                  <li><a href="/pricing.html">Pricing & Plans</a></li>
                  <li><a href="/myaccount/#/signup">Sign up</a></li>
                </ul>
              </div>
            </div>
            <div class="col-sm-4">
              <div class="widget">
                <h6 class="upper">&nbsp;</h6>
                <ul class="list-unstyled">
                  <li><a href="faq.html">FAQs</a></li>
                  <li><a href="#">Hosting</a></li>
                  <li><a href="/terms.html">Privacy policy</a></li>
                </ul>
              </div>
            </div>
            <div class="col-sm-4">
              <div class="widget">
                <h6 class="upper">&nbsp;</h6>
                <ul class="list-unstyled">
                  <li><a href="#">Contact us</a></li>
                  <li><a href="/terms.html">Terms of service</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
       <!--  <div class="col-md-4">
          <div class="row">
            <div class="col-md-12">
              <div class="widget">
                <h6 class="upper">NEWSLETTER SIGN UP</h6>
                <p>Enter your email address below to receive our newsletter</p>
                <div class="footer-newsletter">
                  <form data-mailchimp="true" class="inline-form">
                    <div class="input-group">
                      <input type="email" name="email" placeholder="Email address" class="form-control"><span class="input-group-btn"><button type="submit" data-loading-text="Loading..." class="btn btn-color">SIGN UP</button></span>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div> -->
      </div>
      <!-- end of row-->
    </div>
    <!-- end of container-->
  </footer>
</body>
</html>
